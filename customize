#!/usr/bin/bash
#
# Put customizations to your image in this file.

ROUNDCUBE_VERSION=1.0.1
MUNIN_PLUGIN_VERSION='0.2'

PATH=/opt/local/gnu/bin:/opt/local/bin:/opt/local/sbin:/usr/bin:/usr/sbin

# Exit if any commands fail
set -o errexit

# Configuring image specific packages
echo "* Configuring image specific packages.";
mkdir -p /var/www/roundcubemail

# Download Roundcube and extract it to /var/www
echo "* Download and extract roundcube to /var/www"
curl -L "https://github.com/roundcube/roundcubemail/releases/download/${ROUNDCUBE_VERSION}/roundcubemail-${ROUNDCUBE_VERSION}.tar.gz" | tar xz -C /var/www/roundcubemail --strip-components=1

# Download Roundcube plugins and extract them
echo "* Download Roundcube plugins and extract them"
mkdir -p /var/www/roundcubemail/plugins/html5_notifier
curl -L "https://github.com/kitist/html5_notifier/archive/v0.5.2.tar.gz" | tar xz -C /var/www/roundcubemail/plugins/html5_notifier --strip-components=1
cp /var/www/roundcubemail/plugins/html5_notifier/config/config.inc.php.dist /var/www/roundcubemail/plugins/html5_notifier/config/config.inc.php

# Setup permissions for roundcubemail folders
echo "* Setup permissions for roundcubemail folders"
chown -R www:www /var/www

# Nginx SSL folder
echo "* Create ssl folder"
mkdir -p /opt/local/etc/nginx/ssl

echo "* Enable mdata-setup script"
svccfg import /tmp/mdata-setup.xml
rm /tmp/mdata-setup.xml

# Remove install folder from roundcube
echo "* Remove install folder from roundcube"
rm -r /var/www/roundcubemail/installer

# Create munin template file that will be used during mdata setup
echo "* Create munin template file that will be used during mdata setup"
cp /opt/local/etc/munin/munin-node.conf /opt/local/etc/munin/munin-node.conf.tpl

# Download and install community munin plugins
echo "* Download and install community munin plugins (overwrite all other plugins)"
curl -L https://github.com/drscream/smartos-munin-plugins/archive/v${MUNIN_PLUGIN_VERSION}.tar.gz | tar xz -C /opt/local/lib/munin/plugins

# Clean up
echo "* Cleaning up."
rm -rf /root/*

# Prepare image for provisioning
sm-prepare-image -y
